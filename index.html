<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Poker Ledger – Runde & Verlauf</title>
<style>
  :root{
    --bg:#0e1116; --card:#151a21; --muted:#8fa1b3; --text:#eaf0f6;
    --accent:#d61f45; --ok:#22c55e; --bad:#ef4444;
    --border:#232a35; --gold:#f5bf62; --chip:#5fc7ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.45 system-ui,Segoe UI,Roboto,Arial}

  header{padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.15))}
  h1{font-size:18px;margin:0}
  input,button,select{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  button{cursor:pointer}
  button.accent{background:linear-gradient(180deg,#f43f5e,#b91c1c);border-color:transparent;color:#fff}
  .tabbar{display:flex;gap:8px}
  .tabbar .active{background:var(--accent);border-color:transparent}
  main{padding:16px;max-width:1260px;margin:0 auto}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .pill{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  .table-wrap{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:1120px}
  th,td{padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:middle}
  th{font-size:13px;color:var(--muted);background:rgba(0,0,0,.25);position:sticky;top:0;white-space:nowrap}
  td input{width:100%;text-align:right}
  td.name-cell input{text-align:left}
  .right{text-align:right}.center{text-align:center}.muted{color:var(--muted)}
  .green{color:var(--ok)} .red{color:var(--bad)}
  .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:rgba(0,0,0,.2);white-space:nowrap}
  .badge.ok{border-color:var(--ok);color:var(--ok)}
  .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .timeline{display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto}
  .round-item{border:1px solid var(--border);border-radius:10px;padding:10px;background:rgba(0,0,0,.15)}
  .grid{display:grid;grid-template-columns:1fr 2fr;gap:12px}
  @media(max-width:960px){.grid{grid-template-columns:1fr}}

  /* Mehr Platz & kein Umbruch für Netto/Status */
  td.cell-net, td.cell-money, td.cell-status { white-space:nowrap }
  th.w-net   { min-width:140px }
  th.w-money { min-width:160px }
  th.w-stat  { min-width:150px }

  /* Hintergrund: Schwarz/Rot Pokerbild + Overlays */
  .bg{
    position:fixed; inset:0; z-index:-1;
    background:
      radial-gradient(1200px 600px at 80% 120%, rgba(255,0,0,.15), transparent 60%),
      linear-gradient(160deg, rgba(0,0,0,.55), rgba(120,0,0,.45)),
      url('https://images.unsplash.com/photo-1544928147-79a2dbc1c0d7?auto=format&fit=crop&w=1920&q=80') center/cover no-repeat fixed;
    filter:saturate(105%);
  }

  .tab{display:none}.tab.active{display:block}
  .player-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hint{font-size:12px;color:var(--muted)}

  /* Quotes-Bereich: unter der Tabelle, scrollt mit */
  .quotes-section{
    margin:32px 0 0 0;
    background:linear-gradient(180deg,rgba(70,0,0,.35),rgba(120,0,0,.35));
    border-top:1px solid rgba(255,255,255,.08);
    border-bottom:1px solid rgba(255,255,255,.08);
    padding:22px 0 28px;
  }
  .quotes-row{overflow:hidden;white-space:nowrap;margin:22px 0}
  .quotes-track{
    position:relative; left:-100%;
    display:flex; gap:200px;
    animation:marquee-ltr 480s linear infinite;
    will-change:transform;
  }
  .quote{
    font-style:italic; border:1px solid rgba(255,255,255,.08); padding:12px 20px;
    border-radius:999px; font-size:20px; background:rgba(0,0,0,.28)
  }
  .quote.gold{color:var(--gold)}
  .quote.gold .author{color:#ffe8b8}
  .quote.white{color:#ffffff}
  .quote.white .author{color:#ededed}
  .quote .author{opacity:.95;margin-left:12px}
  @keyframes marquee-ltr{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
</style>
</head>
<body>
<div class="bg"></div>

<header>
  <h1>🃏 Poker Ledger <span style="color:var(--gold)">♠ ♥ ♦ ♣</span></h1>
  <div class="tabbar">
    <button data-tab="current" class="active">Aktuelle Runde</button>
    <button data-tab="history">Verlauf</button>
  </div>
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <span class="hint">Rolle:</span>
    <select id="roleSelect">
      <option value="player" selected>Spieler</option>
      <option value="bank">Bank</option>
      <option value="admin">Admin</option>
      <option value="viewer">Viewer</option>
    </select>

    <!-- Spieler-Profil -->
    <div id="playerTools" class="player-tools">
      <span class="hint">Mein Profil:</span>
      <select id="playerProfileSelect" style="min-width:180px"></select>
      <input id="newPlayerName" placeholder="Neuen Namen anlegen…" style="width:240px">
      <button id="createProfileBtn">Profil anlegen</button>
    </div>

    <span class="hint">Aktuell: <strong id="whoNow">Spieler</strong></span>
  </div>
</header>

<main>
  <!-- Aktuelle Runde -->
  <section id="tab-current" class="tab active">
    <div class="row">
      <div class="pill">
        <label for="buyin">Buy-in (Chips):</label>
        <input id="buyin" type="number" min="1" step="1" value="100" />
      </div>
      <div class="pill">
        <label>1 Chip =</label>
        <input id="chipRate" type="number" min="0" step="0.01" value="0.05">
        <select id="currency" style="width:80px">
          <option value="€" selected>€</option><option value="$">$</option><option value="CHF">CHF</option>
        </select>
      </div>
      <div class="pill">
        <label>Runde:</label>
        <input id="roundName" placeholder="z. B. heutiges Homegame" style="width:260px">
        <button id="finishRound" class="accent">Runde abschließen</button>
      </div>
    </div>

    <div class="controls">
      <input id="playerName" placeholder="Spielername hinzufügen… (Admin/Bank)">
      <button class="accent" id="addPlayer">+ Spieler</button>
      <button id="validate">Konsistenz prüfen</button>
      <div style="flex:1"></div>
      <button id="exportBtn">Export</button>
      <button id="importBtn">Import</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="resetBtn" style="border-color:var(--bad);color:var(--bad)">Alles löschen</button>
    </div>

    <div class="table-wrap">
      <table id="ledger">
        <thead>
          <tr>
            <th style="width:30px">#</th>
            <th>Spieler</th>
            <th class="right">Rebuys</th>
            <th class="right">Buy-ins gesamt (Chips)</th>
            <th class="right">Aktuelle Chips</th>
            <th class="right w-net">Netto (Chips)</th>
            <th class="right w-money">Netto (Geld)</th>
            <th class="center w-stat">Status</th>
            <th class="right">Aktionen</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
        <tfoot>
          <tr>
            <td colspan="2"><span class="hint">Summe</span></td>
            <td class="right"><span id="sumRebuys" class="badge"></span></td>
            <td class="right"><span id="sumBuyins" class="badge"></span></td>
            <td class="right"><span id="sumChips" class="badge"></span></td>
            <td class="right"><span id="sumNet" class="badge"></span></td>
            <td class="right"><span id="sumNetMoney" class="badge"></span></td>
            <td class="center"><span id="paidCount" class="badge"></span></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <!-- Verlauf -->
  <section id="tab-history" class="tab">
    <div class="grid">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">🕒 Verlauf</h3>
          <div class="row">
            <label class="hint">Spielerfilter:</label>
            <select id="historyFilter" style="min-width:180px"></select>
            <button id="clearFilter">X</button>
          </div>
        </div>
        <div id="timeline" class="timeline" style="margin-top:10px"></div>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">📊 Spieler-Stats</h3>
        <div class="hint" id="statsHint">Wähle oben dein Spieler-Profil, um deine Stats zu sehen.</div>
        <div id="myStats" style="display:none">
          <div>Gesamt Rebuys: <strong id="sRebuys">0</strong></div>
          <div>Gesamt Netto (Chips): <strong id="sNetChips">0</strong></div>
          <div>Gesamt Netto (Geld): <strong id="sNetMoney">0,00 €</strong></div>
          <div>Gewinn-Runden: <strong id="sWins">0</strong> · Verlust-Runden: <strong id="sLosses">0</strong></div>
          <div class="hint" style="margin-top:6px">Nur abgeschlossene Runden zählen.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Zitate-Bereich (unter der Tabelle, scrollt mit) -->
  <section class="quotes-section">
    <div class="quotes-row"><div id="quotesTrack1" class="quotes-track"></div></div>
    <div class="quotes-row"><div id="quotesTrack2" class="quotes-track"></div></div>
    <div class="quotes-row"><div id="quotesTrack3" class="quotes-track"></div></div>
  </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = id => document.getElementById(id);

  /* ---------- STATE ---------- */
  const state = {
    buyinChips: 100,
    chipRate: 0.05,
    currency: "€",
    roundName: "",
    players: [],
    rounds: [],
    role: { kind:'player', playerId:null }, // Start als Spieler
    dealerTips: 0 // unsichtbar, nur für Konsistenz
  };

  const save = ()=> localStorage.setItem('poker-ledger-v7', JSON.stringify(state));
  const load = ()=> { try{ Object.assign(state, JSON.parse(localStorage.getItem('poker-ledger-v7')||'{}')); }catch{} };

  /* ---------- HELPERS ---------- */
  const clampInt = (v, min=0)=> Math.max(min, Math.floor(Number(v)||0));
  const sum=a=>a.reduce((x,y)=>x+y,0);
  const fmtInt=n=>(Number(n)||0).toLocaleString('de-DE',{maximumFractionDigits:0});
  const fmtMoney=n=> (Number(n)||0).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+' '+state.currency;
  const todayStr=()=> new Date().toLocaleDateString('de-DE');
  const nextId=list=> Math.max(0,...list.map(x=>x.id||0))+1;
  const getPlayerById=id=> state.players.find(p=>p.id===id);
  const getPlayerByName=name=> state.players.find(p=>(p.name||'').toLowerCase()===(name||'').toLowerCase());
  const isAdminLike=()=> state.role.kind==='admin'||state.role.kind==='bank';
  const canConfirmPayment=()=> isAdminLike();
  const canEditRow=pid=> isAdminLike() || (state.role.kind==='player' && state.role.playerId===pid);

  /* ---------- UI refs ---------- */
  const buyinEl=$('buyin'), chipRateEl=$('chipRate'), currencyEl=$('currency'), roundNameEl=$('roundName'), finishRoundBtn=$('finishRound');
  const playerNameEl=$('playerName'), addPlayerBtn=$('addPlayer'), validateBtn=$('validate');
  const exportBtn=$('exportBtn'), importBtn=$('importBtn'), importFile=$('importFile'), resetBtn=$('resetBtn');
  const rowsTbody=$('rows');
  const roleSelect=$('roleSelect'), whoNow=$('whoNow');

  const playerTools=$('playerTools'), playerProfileSelect=$('playerProfileSelect'), newPlayerName=$('newPlayerName'), createProfileBtn=$('createProfileBtn');

  const timelineEl=$('timeline'), historyFilter=$('historyFilter'), clearFilter=$('clearFilter');
  const statsHint=$('statsHint'), myStatsWrap=$('myStats'), sRebuys=$('sRebuys'), sNetChips=$('sNetChips'), sNetMoney=$('sNetMoney'), sWins=$('sWins'), sLosses=$('sLosses');

  /* ---------- RENDER ---------- */
  function computeTotals(){
    const totals = state.players.map(p=>{
      const rebuys=clampInt(p.rebuys); const buyinsTotal=(1+rebuys)*state.buyinChips; const chips=clampInt(p.chips,0); const net=chips-buyinsTotal;
      return {rebuys,buyinsTotal,chips,net,paid:!!p.paid?.ok};
    });
    const sumRebuys = sum(totals.map(t=>t.rebuys));
    const sumBuyins = sum(totals.map(t=>t.buyinsTotal));
    const sumChips  = sum(totals.map(t=>t.chips));
    const sumNet    = sum(totals.map(t=>t.net));
    const sumNetMoney = sumNet*state.chipRate;
    const paidCount = totals.filter(t=>t.paid).length;

    $('sumRebuys').textContent=sumRebuys;
    $('sumBuyins').textContent=fmtInt(sumBuyins)+' Chips';
    $('sumChips').textContent =fmtInt(sumChips)+' Chips';
    $('sumNet').textContent   =(sumNet>0?'+':'')+fmtInt(sumNet)+' Chips';
    $('sumNet').className='badge '+(sumNet===0?'':(sumNet>0?'ok':''));
    $('sumNetMoney').textContent=(sumNetMoney>0?'+':'')+fmtMoney(sumNetMoney);
    $('paidCount').textContent=`${paidCount} / ${state.players.length} bezahlt`;
    $('paidCount').className='badge '+(paidCount===state.players.length && state.players.length>0 ? 'ok':'');
  }

  function rowHtml(p, idx){
    const rebuys=clampInt(p.rebuys); const buyinsTotal=(1+rebuys)*state.buyinChips; const chips=clampInt(p.chips,0);
    const netChips=chips-buyinsTotal; const netMoney=netChips*state.chipRate;
    const isMine=canEditRow(p.id); const locked=!!p.paid?.ok; const editable=(isMine||isAdminLike()) && !locked;
    const status = p.paid?.ok ? `<span class="badge ok">✅ paid</span>` : `<span class="badge">open</span>`;
    return `
      <td class="muted" style="font-size:12px">${idx+1}</td>
      <td class="name-cell"><input data-k="name" value="${p.name||''}" ${editable||isAdminLike()?'':'disabled'} ${locked?'disabled':''}></td>
      <td class="right"><input data-k="rebuys" type="number" min="0" step="1" value="${rebuys}" ${editable?'':'disabled'}></td>
      <td class="right"><span data-k="buyinsText" class="muted">${fmtInt(buyinsTotal)} Chips</span></td>
      <td class="right"><input data-k="chips" type="number" min="0" step="1" value="${chips}" ${editable?'':'disabled'}></td>
      <td class="right cell-net"><strong data-k="netChips" class="${netChips>0?'green':(netChips<0?'red':'')}">${netChips>0?'+':''}${fmtInt(netChips)}</strong></td>
      <td class="right cell-money"><strong data-k="netMoney" class="${netMoney>0?'green':(netMoney<0?'red':'')}">${netMoney>0?'+':''}${fmtMoney(netMoney)}</strong></td>
      <td class="center cell-status">
        <label class="muted" style="font-size:12px;white-space:nowrap">
          <input type="checkbox" data-k="paid" ${p.paid?.ok?'checked':''} ${canConfirmPayment()?'':'disabled'}>
          ${status}
        </label>
      </td>
      <td class="right">
        <button class="ghost small" data-action="tip" ${editable?'':'disabled'} title="Auf nächsten 10er abrunden (Dealer Tip)">💰 Dealer Tip</button>
        <button class="ghost small" data-action="rebuy" ${editable?'':'disabled'}>+ Rebuy</button>
        <button class="ghost small" data-action="delete" ${isAdminLike()?'':'disabled'}>Remove</button>
      </td>`;
  }
  function attachRowHandlers(tr,p){
    const isMine=canEditRow(p.id);
    const updateDerived=()=>{
      const rebuys=clampInt(p.rebuys), buyinsTotal=(1+rebuys)*state.buyinChips, chips=clampInt(p.chips,0);
      const netChips=chips-buyinsTotal, netMoney=netChips*state.chipRate;
      tr.querySelector('[data-k="buyinsText"]').textContent=`${fmtInt(buyinsTotal)} Chips`;
      const nc=tr.querySelector('[data-k="netChips"]'); nc.textContent=`${netChips>0?'+':''}${fmtInt(netChips)}`; nc.className=(netChips>0?'green':(netChips<0?'red':''));
      const nm=tr.querySelector('[data-k="netMoney"]'); nm.textContent=`${netMoney>0?'+':''}${fmtMoney(netMoney)}`; nm.className=(netMoney>0?'green':(netMoney<0?'red':''));
    };
    tr.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const k=inp.dataset.k; const locked=!!p.paid?.ok;
        if (locked && (k==='name'||k==='rebuys'||k==='chips')){ inp.value = k==='name'? p.name : (k==='rebuys'? p.rebuys : p.chips); return; }
        if (k==='name'){ if (!(isMine||isAdminLike())){ inp.value=p.name||''; return; } p.name=inp.value; }
        if (k==='rebuys'){ if (!(isMine||isAdminLike())){ inp.value=p.rebuys||0; return; } p.rebuys=clampInt(inp.value,0); }
        if (k==='chips'){ if (!(isMine||isAdminLike())){ inp.value=p.chips||0; return; } p.chips=clampInt(inp.value,0); }
        if (k==='paid'){ if (!canConfirmPayment()){ inp.checked=!!p.paid?.ok; return; } const ok=inp.checked; p.paid = ok? {ok:true,by:(state.role.kind==='admin'?'Admin':'Bank'),at:Date.now()} : {ok:false};
          tr.querySelectorAll('input[data-k="name"],input[data-k="rebuys"],input[data-k="chips"]').forEach(i=> ok? i.setAttribute('disabled','') : i.removeAttribute('disabled'));
        }
        save(); updateDerived(); computeTotals(); updateFinishRoundState();
      });
    });
    tr.querySelector('[data-action="rebuy"]').addEventListener('click', ()=>{
      if (!!p.paid?.ok) return; if (!(isMine||isAdminLike())) return;
      p.rebuys=clampInt((p.rebuys||0)+1,0); tr.querySelector('input[data-k="rebuys"]').value=p.rebuys; save(); updateDerived(); computeTotals(); updateFinishRoundState();
    });
    tr.querySelector('[data-action="delete"]').addEventListener('click', ()=>{
      if (!isAdminLike()) return; if (!confirm(`Spieler „${p.name||('#'+p.id)}“ entfernen?`)) return;
      const removedMine = (state.role.kind==='player' && state.role.playerId===p.id);
      state.players = state.players.filter(x=>x.id!==p.id);
      if (removedMine){ state.role.playerId=null; }
      save(); renderAll();
    });

    // 💰 Dealer Tip: runde Chips auf den nächsten 10er nach unten (141→140, 143→140)
    tr.querySelector('[data-action="tip"]').addEventListener('click', ()=>{
      if (!!p.paid?.ok) return;
      if (!(isMine||isAdminLike())) return;

      const remainder = p.chips % 10; // Rest bis zum 10er
      if (remainder === 0) {
        alert('Schon glatt: Chips sind bereits ein Vielfaches von 10.');
        return;
      }
      const tipChips = remainder; // genau so viele Chips als Dealer Tip
      if (tipChips > 0 && tipChips <= p.chips) {
        p.chips -= tipChips;
        state.dealerTips = (state.dealerTips||0) + tipChips;
        save(); updateDerived(); computeTotals(); updateFinishRoundState();
      }
    });

    updateDerived();
  }
  function renderRows(){
    rowsTbody.innerHTML='';
    state.players.forEach((p,idx)=>{
      const tr=document.createElement('tr'); tr.innerHTML=rowHtml(p,idx);
      rowsTbody.appendChild(tr); attachRowHandlers(tr,p);
    });
  }

  function fillHistoryFilter(){
    const prev=historyFilter.value||'';
    historyFilter.innerHTML='<option value="">— alle Spieler —</option>'+state.players.map(p=>`<option value="${p.id}">${p.name||('ID '+p.id)}</option>`).join('');
    historyFilter.value=prev;
  }
  function renderTimeline(){
    timelineEl.innerHTML='';
    let rounds=[...state.rounds].sort((a,b)=>b.date-a.date);
    const filterVal = historyFilter.value||'';
    if (filterVal){ const pid=Number(filterVal); rounds = rounds.map(r=>({ ...r, entries: r.entries.filter(e=>e.playerId===pid) })).filter(r=>r.entries.length>0); }
    if (!rounds.length){ timelineEl.innerHTML='<div class="hint">Noch keine abgeschlossene Runde.</div>'; return; }
    rounds.forEach(r=>{
      const winners=[...r.entries].sort((a,b)=>b.netMoney-a.netMoney);
      const top=winners[0], bottom=winners[winners.length-1];
      const euro=x=>(x||0).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+' '+r.currency;
      const div=document.createElement('div'); div.className='round-item';
      div.innerHTML=`
        <div style="display:flex;justify-content:space-between;flex-wrap:wrap;">
          <div><strong>${r.name}</strong> <span class="hint">(${new Date(r.date).toLocaleString('de-DE')})</span></div>
          <div class="hint">Buy-in: ${r.buyinChips} Chips · 1 Chip = ${r.chipRate.toFixed(2)} ${r.currency}</div>
        </div>
        <div class="small" style="margin-top:6px">Spieler: <strong>${r.entries.length}</strong> · Summe Netto: <strong>${(r.totals.netChips>0?'+':'')}${fmtInt(r.totals.netChips)} Chips</strong> · <strong>${(r.totals.netMoney>0?'+':'')}${euro(r.totals.netMoney)}</strong></div>
        <div class="small" style="margin-top:6px">Top: <strong>${top?.name||'-'}</strong> (${top?.netMoney>0?'+':''}${euro(top?.netMoney)}) · Flop: <strong>${bottom?.name||'-'}</strong> (${bottom?.netMoney>0?'+':''}${euro(bottom?.netMoney)})</div>`;
      timelineEl.appendChild(div);
    });
  }
  function renderMyStats(){
    if (state.role.kind!=='player' || !state.role.playerId){ statsHint.style.display=''; myStatsWrap.style.display='none'; return; }
    const me=getPlayerById(state.role.playerId); if (!me){ statsHint.style.display=''; myStatsWrap.style.display='none'; return; }
    let reb=0,netC=0,netM=0,wins=0,losses=0;
    for (const r of state.rounds){ const e=r.entries.find(x=>x.playerId===me.id); if(!e) continue; reb+=e.rebuys; netC+=e.netChips; netM+=e.netMoney; if(e.netMoney>0) wins++; else if(e.netMoney<0) losses++; }
    sRebuys.textContent=reb; sNetChips.textContent=(netC>0?'+':'')+fmtInt(netC);
    sNetMoney.textContent=((netM>0?'+':'')+fmtMoney(netM));
    sWins.textContent=wins; sLosses.textContent=losses;
    statsHint.style.display='none'; myStatsWrap.style.display='';
  }
  function updateFinishRoundState(){
    const everyonePaid = state.players.length>0 && state.players.every(p=>p.paid?.ok);
    finishRoundBtn.disabled = !isAdminLike() || !everyonePaid;
    finishRoundBtn.classList.toggle('lock', finishRoundBtn.disabled);
  }
  function renderPlayerTools(){
    playerTools.style.display = (state.role.kind==='player') ? '' : 'none';
    playerProfileSelect.innerHTML = '<option value="">— Profil wählen —</option>' +
      state.players.map(p=>`<option value="${p.id}">${p.name||('ID '+p.id)}</option>`).join('');
    if (state.role.playerId){ playerProfileSelect.value = String(state.role.playerId); }
    const roleTxt = (state.role.kind==='player' && state.role.playerId) ?
      `Spieler: ${getPlayerById(state.role.playerId)?.name||''}` :
      (state.role.kind==='admin'?'Admin':state.role.kind==='bank'?'Bank':state.role.kind==='viewer'?'Viewer':'Spieler');
    whoNow.textContent = roleTxt;
  }
  function renderAll(){
    buyinEl.value=state.buyinChips; chipRateEl.value=state.chipRate; currencyEl.value=state.currency;
    if (!state.roundName) state.roundName = todayStr()+' Homegame';
    roundNameEl.value=state.roundName;
    renderPlayerTools();
    computeTotals(); renderRows(); renderTimeline(); fillHistoryFilter(); renderMyStats(); updateFinishRoundState();
  }

  /* ---------- ACTIONS ---------- */
  document.querySelectorAll('.tabbar button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabbar button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
    });
  });

  roleSelect.addEventListener('change', ()=>{
    state.role.kind = roleSelect.value;
    if (state.role.kind!=='player'){ state.role.playerId=null; }
    save(); renderAll();
  });
  playerProfileSelect.addEventListener('change', ()=>{
    const pid = Number(playerProfileSelect.value||0);
    state.role.playerId = pid || null;
    save(); renderAll();
  });
  function createProfile(){
    const name = (newPlayerName.value||'').trim();
    if (!name){ alert('Bitte Namen eingeben.'); return; }
    if (getPlayerByName(name)){ alert('Name existiert bereits.'); return; }
    const id = nextId(state.players);
    state.players.push({id,name,rebuys:0,chips:100,paid:{ok:false}}); // Start mit 100 Chips
    state.role.kind='player'; state.role.playerId=id;
    newPlayerName.value='';
    save(); renderAll();
  }
  createProfileBtn.addEventListener('click', createProfile);
  newPlayerName.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); createProfile(); } });

  addPlayerBtn.addEventListener('click', ()=>{
    if(!isAdminLike()){ alert('Nur Admin/Bank kann Spieler hinzufügen.'); return; }
    const name=(playerNameEl.value||'').trim(); if(!name) return;
    if (getPlayerByName(name)){ alert('Name existiert bereits.'); return; }
    state.players.push({id:nextId(state.players),name,rebuys:0,chips:100,paid:{ok:false}}); // Start mit 100 Chips
    playerNameEl.value=''; save(); renderAll();
  });

  buyinEl.addEventListener('change', ()=>{ if(!isAdminLike()){ buyinEl.value=state.buyinChips; return; } state.buyinChips=Math.max(1,Math.floor(Number(buyinEl.value)||100)); save(); renderRows(); computeTotals(); });
  chipRateEl.addEventListener('change', ()=>{ if(!isAdminLike()){ chipRateEl.value=state.chipRate; return; } const v=Number(chipRateEl.value); state.chipRate=isNaN(v)||v<0?0:v; save(); renderRows(); computeTotals(); });
  currencyEl.addEventListener('change', ()=>{ if(!isAdminLike()){ currencyEl.value=state.currency; return; } state.currency=currencyEl.value||'€'; save(); renderRows(); computeTotals(); });
  roundNameEl.addEventListener('input', ()=>{ if(!isAdminLike()) return; state.roundName=roundNameEl.value; save(); });

  validateBtn.addEventListener('click', ()=>{
    const totalBuyins=sum(state.players.map(p=>(1+clampInt(p.rebuys))*state.buyinChips));
    const totalChips=sum(state.players.map(p=>clampInt(p.chips,0)));
    const diffAdj = (totalChips + (state.dealerTips||0)) - totalBuyins;
    alert(diffAdj===0?'✅ Konsistent (inkl. Dealer Tips).':`⚠️ Abweichung (inkl. Dealer Tips): ${(diffAdj>0?'+':'')}${diffAdj} Chips.`);
  });

  finishRoundBtn.addEventListener('click', ()=>{
    if (!isAdminLike()) return;
    if (!state.players.length || !state.players.every(p=>p.paid?.ok)){ alert('Noch nicht alle bezahlt.'); return; }
    const entries=state.players.map(p=>{
      const rebuys=clampInt(p.rebuys), chips=clampInt(p.chips,0), buyinsTotal=(1+rebuys)*state.buyinChips, netChips=chips-buyinsTotal, netMoney=netChips*state.chipRate;
      return {playerId:p.id,name:p.name||('#'+p.id),rebuys,chips,netChips,netMoney};
    });
    const totals={rebuys:sum(entries.map(e=>e.rebuys)),buyins:sum(entries.map(e=>(1+e.rebuys)*state.buyinChips)),chips:sum(entries.map(e=>e.chips)),netChips:sum(entries.map(e=>e.netChips)),netMoney:sum(entries.map(e=>e.netMoney))};
    state.rounds.push({id:nextId(state.rounds),name:(state.roundName||todayStr()+' Homegame'),date:Date.now(),buyinChips:state.buyinChips,chipRate:state.chipRate,currency:state.currency,entries,totals});
    // Reset für neue Runde
    state.players.forEach(p=>{ p.paid={ok:false}; p.rebuys=0; p.chips=100; }); // neue Runde wieder mit 100 starten
    state.dealerTips = 0; // Tips zurücksetzen
    state.roundName = todayStr()+' Homegame';
    save(); renderAll(); buildQuotes(true); alert('✅ Runde gespeichert & zurückgesetzt. Quotes neu gemischt.');
  });

  exportBtn.addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`poker-ledger-v7-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
    a.click(); URL.revokeObjectURL(url);
  });
  importBtn.addEventListener('click', ()=>importFile.click());
  importFile.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return; const text=await f.text();
    try{ const data=JSON.parse(text); if(!data||typeof data!=='object') throw new Error('Ungültige Datei'); Object.assign(state,data); save(); renderAll(); }
    catch(err){ alert('Import fehlgeschlagen: '+err.message); } finally{ e.target.value=''; }
  });
  resetBtn.addEventListener('click', ()=>{
    if(!isAdminLike()){ alert('Nur Admin oder Bank kann das anstoßen.'); return; }
    if(!confirm('Sicher? Zum Löschen müssen Admin und Bank zustimmen.')) return;
    const bank = prompt('Bank-Zustimmung (Tippe „bank“):'); if((bank||'').toLowerCase()!=='bank'){ alert('Bank-Zustimmung fehlt.'); return; }
    const admin = prompt('Admin-Zustimmung (Tippe „admin“):'); if((admin||'').toLowerCase()!=='admin'){ alert('Admin-Zustimmung fehlt.'); return; }
    if(!confirm('Letzte Bestätigung: Wirklich ALLES löschen?')) return;
    localStorage.removeItem('poker-ledger-v7'); location.reload();
  });

  /* ---------- QUOTES (unter der Tabelle) ---------- */
  const authorsRaw = [
    "S. Harvey","Steve Harvey","Stephan Harvey","Steve H.","Stephan H.","Stephan \"Steve\" Harvey",
    "The Host from Familiy Feud","A dedicated game show host","Steve the Gambling Man",
    "A man with a very prominent mustache","S. H.","Steve (not from Minecraft)"
  ];
  const normAuthor = a => /^steve\b/i.test(a) ? "Steve H." : (/^stephan\b/i.test(a) ? "Stephan H." : a);
  const quotes = [
    "Give me six hours to chop down a tree, and I will spend the first four at the blackjack table.",
    "A journey of a thousand miles begins with a single chip.",
    "Fortune favors the bold… and the guy who bluffs with 7-2 offsuit.",
    "The early bird catches the worm, but the second mouse gets the jackpot.",
    "What doesn’t kill you makes you double down.",
    "When life gives you lemons, bet them on red.",
    "You miss 100% of the shots you don’t take… and 100% of the hands you fold.",
    "Winners never quit, quitters cash out too early.",
    "Don’t count your chickens before they hatch – count your chips before the dealer sees them.",
    "The pen is mightier than the sword, but the ace of spades beats them both.",
    "If at first you don’t succeed, try re-buying.",
    "Work smart, not hard – or just find a lucky slot machine.",
    "Rome wasn’t built in a day, but my bankroll disappeared in one night.",
    "Great minds think alike, but gamblers think the deck is rigged.",
    "The best way to predict the future is to bet on it.",
    "Slow and steady wins the race – unless there’s a time limit on the poker clock.",
    "Luck is what happens when preparation meets opportunity… at the roulette table.",
    "It’s not whether you win or lose, it’s how many free drinks you get.",
    "Success is 1% inspiration, 99% trying to get your chips back.",
    "Hard work beats talent, unless talent hits a royal flush.",
    "If opportunity doesn’t knock, build a casino.",
    "A goal without a plan is just a wish – and a poker hand without chips is just a dream.",
    "Don’t watch the clock, watch the dealer.",
    "Hustle in silence, let your chips make the noise.",
    "If you’re going through hell, double down.",
    "Shoot for the moon. Even if you miss, you’ll land in the high-roller lounge.",
    "Don’t be afraid to give up the good to chase the jackpot.",
    "Discipline is choosing between what you want now and what you want most – unless there’s a hot table.",
    "If I had four hours to cut down a tree, I’d spend the first three at the craps table.",
    "Gamble like there’s no tomorrow… because after this hand, there might not be."
  ];

  function buildAuthorStream(targetLength){
    const names = authorsRaw.map(normAuthor);
    const twoEach = []; names.forEach(n=>{ twoEach.push(n,n); });
    const stream = [];
    while(stream.length < targetLength){
      const chunk = [...twoEach].map(x=>({x, r:Math.random()})).sort((a,b)=>a.r-b.r).map(o=>o.x);
      stream.push(...chunk);
    }
    return stream.slice(0,targetLength);
  }

  function fillTrack(el, items){
    el.innerHTML='';
    const all = items.concat(items); // doppelt für nahtlosen Lauf
    all.forEach(({text,author})=>{
      const span=document.createElement('span');
      span.className='quote '+(Math.random()<0.5?'gold':'white');
      span.innerHTML=`“${text}” <span class="author">— ${author}</span>`;
      el.appendChild(span);
    });
  }

  function buildQuotes(remix=false){
    const t1=$('quotesTrack1'), t2=$('quotesTrack2'), t3=$('quotesTrack3');
    if (remix){ t1.innerHTML=t2.innerHTML=t3.innerHTML=''; }
    const shuffled = quotes.map(q=>({q,r:Math.random()})).sort((a,b)=>a.r-b.r).map(o=>o.q);
    const totalPerBuild = Math.max(60, shuffled.length);
    const authorStream = buildAuthorStream(totalPerBuild);
    const items = [];
    for(let i=0;i<totalPerBuild;i++){
      items.push({ text: shuffled[i % shuffled.length], author: authorStream[i] });
    }
    const line1 = items.filter((_,i)=> i%3===0);
    const line2 = items.filter((_,i)=> i%3===1);
    const line3 = items.filter((_,i)=> i%3===2);
    fillTrack(t1, line1); fillTrack(t2, line2); fillTrack(t3, line3);
  }

  /* ---------- INIT ---------- */
  load();
  if (state.players.length===0){
    state.players.push({id:1,name:'Player A',rebuys:0,chips:100,paid:{ok:false}});
    state.players.push({id:2,name:'Player B',rebuys:0,chips:100,paid:{ok:false}});
  }
  if (!state.roundName) state.roundName = todayStr()+' Homegame';

  document.querySelectorAll('.tabbar button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabbar button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
    });
  });

  function updateFinishRoundState(){
    const everyonePaid = state.players.length>0 && state.players.every(p=>p.paid?.ok);
    finishRoundBtn.disabled = !isAdminLike() || !everyonePaid;
    finishRoundBtn.classList.toggle('lock', finishRoundBtn.disabled);
  }

  historyFilter.addEventListener('change', renderTimeline);
  clearFilter.addEventListener('click', ()=>{ historyFilter.value=''; renderTimeline(); });

  buildQuotes(true);
  renderAll();
});
</script>
</body>
</html>
